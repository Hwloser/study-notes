# SSL/TLS 工作原理和详细握手过程

## HTTPS 和 HTTP的区别

![](SSLTLS%20%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E5%92%8C%E8%AF%A6%E7%BB%86%E6%8F%A1%E6%89%8B%E8%BF%87%E7%A8%8B.assets/1866628594-5e11d64f42c8e_articlex.png)

显然，HTTPS 相比 HTTP最大的不同就是多了一层 SSL (Secure Sockets Layer 安全套接层)或 TLS (Transport Layer Security 安全传输层协议)。有了这个安全层，就确保了互联网上通信双方的通信安全，那么这个安全层是怎么工作的，SSL / TLS 握手过程又是怎样的呢？

## SSL / TLS 以及 SSL / TLS 握手的概念

SSL 和 TLS 协议可以为通信双方提供识别和认证通道，从而保证通信的机密性和数据完整性。TLS 协议是从netspace SSL v3.0协议演变而来的，不过这两种协议并不互相兼容，SSL已经逐渐被TLS取代。TLS 握手是启动HTTPS通信的过程，类似于TCP建立连接时 的三次握手。在TLS握手的过程中，通信双方交换信息以相互验证，相互确认，并确立它们所有使用的加密算法以及回话秘钥（用于堆成加密的秘钥）。可以说，TLS 握手是 HTTPS 通信的基础部分。

## TLS 握手流程

1. 商定双方通信所使用的TLS版本协议（例如 TLS1.0, 1.2, 1.3等等）。
2. 确定双方所要使用的密码组合。
3. 客户端通过服务器的公钥和数字证书上的数字签名验证服务端的身份。
4. 生成回话秘钥，该秘钥将用于握手结束后的堆成加密。

## TLS 握手详细过程

![](SSLTLS%20%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E5%92%8C%E8%AF%A6%E7%BB%86%E6%8F%A1%E6%89%8B%E8%BF%87%E7%A8%8B.assets/2771952479-5e1ad3408e724_articlex.png)

1. "client hello"message：客户端通过发送“client hello”消息向服务器发送握手请求，该消息包含了客户端所支持的TLS版本和密码组合一共服务器进行选择，还有一个“client random”随机字符串。
2. “server hello”message：服务器发送“server hello”消息对客户端进行response，该消息包含了数字证书，服务器选择的密码组合和“server random”随机字符串。
3. 验证：客户端对服务器发来的证书进行验证，确保对方的合法身份。
   1. 检查数字签名
   2. 验证证书链
   3. 检查证书的有效期
   4. 检查证书的撤回状态
4. “premaster secret”字符串：客户端向服务器发送另一个随机字符串“premaster secret（预主密钥）”，这个字符串是经过服务器的公钥进行加密过的，只有对应的私有才能解密成功。
5. 使用私钥：服务器使用私钥解密“premaster secret”。
6. 生成共享秘钥：客户端和服务器均使用 client random，server random 和 premaster secret，并通过相同的算法生成相同的共享密钥 **KEY**。
7. 客户端就绪：客户端发送经过共享密钥 **KEY**加密过的"finished"信号。
8. 服务器就绪：服务器发送经过共享密钥 **KEY**加密过的"finished"信号。
9. 达成安全通信：握手完成，双方使用对称加密进行安全通信。

## terminology

### 数字证书 (digital certificate)

在非对称加密通信过程中，服务器需要将公钥发送给客户端，在这一过程中，公钥很可能会被第三方拦截并替换，然后这个第三方就可以冒充服务器与客户端进行通信，这就是传说中的“中间人攻击”(man in the middle attack)。解决此问题的方法是通过受信任的第三方交换公钥，具体做法就是服务器不直接向客户端发送公钥，而是要求受信任的第三方，也就是证书认证机构 (Certificate Authority, 简称 CA)将公钥合并到数字证书中，然后服务器会把公钥连同证书一起发送给客户端，私钥则由服务器自己保存以确保安全。数字证书一般包含以下内容：

1. 证书所有者的公钥
2. 证书所有者的专有名称
3. 证书颁发机构的专有名称
4. 证书的有效起始日期
5. 证书的过期日期
6. 证书数据格式的版本号
7. 序列号，这是证书颁发机构为该证书分配的唯一标识符
8. ... ...

### 数字签名 (digital signature)

这个概念很好理解，其实跟人的手写签名类似，是为了确保数据发送者的合法身份，也可以确保数据内容未遭到篡改，保证数据完整性。与手写签名不同的是，数字签名会随着文本数据的变化而变化。具体到数字证书的应用场景，数字签名的生成和验证流程如下：

1. 服务器对证书内容进行信息摘要计算 (常用算法有 SHA-256等)，得到摘要信息，再用私钥把摘要信息加密，就得到了数字签名
2. 服务器把数字证书连同数字签名一起发送给客户端
3. 客户端用公钥解密数字签名，得到摘要信息
4. 客户端用相同的信息摘要算法重新计算证书摘要信息，然后对这两个摘要信息进行比对，如果相同，则说明证书未被篡改，否则证书验证失败

### 证书链 (certificate chain)

证书链，也称为证书路径，是用于认证实体合法身份的证书列表，具体到 HTTPS 通信中，就是为了验证服务器的合法身份。之所以使用证书链，是为了保证根证书 (root CA certificate)的安全，中间层可以看做根证书的代理，起到了缓冲的作用，如下图所示，这里还以 B 站证书为例：

![](SSLTLS%20%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E5%92%8C%E8%AF%A6%E7%BB%86%E6%8F%A1%E6%89%8B%E8%BF%87%E7%A8%8B.assets/2097043943-5e1fc2b79369e_articlex.png)

证书链从根证书开始，并且证书链中的每一级证书所标识的实体都要为其下一级证书签名，而根证书自身则由证书颁发机构签名。客户端在验证证书链时，必须对链中所有证书的数字签名进行验证，直到达到根证书为止。

### 密码规范和密码组合 (CipherSpecs 和 CipherSuites)

通信双方在安全连接中所使用的算法必须符合密码安全协议的规定，CipherSpecs 和 CipherSuites 正好定义了合法的密码算法组合。CipherSpecs 用于认证加密算法和信息摘要算法的组合，通信双方必须同意这个密码规范才能进行通信。而 CipherSuites 则定义了 SSL / TLS 安全连接中所使用的加密算法的组合，该组合包含三种不同的算法：

1. 握手期间所使用的的密钥交换和认证算法 (最常用的是 RSA 算法)
2. 加密算法 (用于握手完成后的对称加密，常用的有 AES、3DES等)
3. 信息摘要算法 (常用的有 SHA-256、SHA-1 和 MD5 等)